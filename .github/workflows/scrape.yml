name: PainPointRadar CI + Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Job 1: CI - Run tests and linting on every push/PR
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest
          
      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short
          
      - name: Test notification (optional)
        if: always() && (env.SLACK_WEBHOOK_URL != '' || env.DISCORD_WEBHOOK_URL != '')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="PainPointRadar CI: $STATUS on ${{ github.ref_name }}"
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"content\":\"$MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL" || true
          fi

  # Job 2: Pipeline - Run the scrape + analysis pipeline (on main/schedule/dispatch only)
  pipeline:
    runs-on: ubuntu-latest
    needs: ci
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install -r requirements.txt
        
      - name: Run pipeline
        run: python -m src.main --subreddits SaaS --limit 200
        
      - name: Prepare public directory
        run: |
          mkdir -p public
          cp output/* public/ 2>/dev/null || true
          
      - name: Generate index page
        run: |
          python3 << 'EOF'
          import os
          html = """<!DOCTYPE html>
          <html>
          <head><title>PainPointRadar Reports</title></head>
          <body><h1>PainPointRadar Reports</h1><ul>
          <li><a href="sample_output.csv">sample_output.csv</a></li>
          <li><a href="sample_output.xlsx">sample_output.xlsx</a></li>
          <li><a href="validation_report.html">validation_report.html</a></li>
          </ul></body></html>"""
          os.makedirs("public", exist_ok=True)
          with open("public/index.html", "w") as f:
              f.write(html)
          EOF
          
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          
      - name: Pipeline notification (optional)
        if: always() && (env.SLACK_WEBHOOK_URL != '' || env.DISCORD_WEBHOOK_URL != '')
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="PainPointRadar Pipeline: $STATUS - Reports deployed to GitHub Pages"
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"$MESSAGE\"}" \
              "$SLACK_WEBHOOK_URL" || true
          fi
          if [ -n "$DISCORD_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"content\":\"$MESSAGE\"}" \
              "$DISCORD_WEBHOOK_URL" || true
          fi